{% extends "base.html" %}

{% block title %}Log Details - SMS Admin{% endblock %}

{% block page_title %}Message Log Details{% endblock %}

{% block breadcrumbs %}
<a href="{{ url_for('main.dashboard') }}">Dashboard</a> /
<a href="{{ url_for('main.logs_list') }}">Logs</a> /
<span>Details</span>
{% endblock %}

{% block page_actions %}
<a href="{{ url_for('main.logs_list') }}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left me-1"></i>Back to Logs
</a>
{% endblock %}

{% block content %}
<div id="logStatusMeta" class="d-none"
     data-log-id="{{ log.id }}"
     data-status="{{ log.status }}"
     data-success-count="{{ log.success_count or 0 }}"
     data-failure-count="{{ log.failure_count or 0 }}"></div>
<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card app-card">
            <div class="card-header">
                <h6 class="mb-0">Summary</h6>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>Sent At</dt>
                    <dd>{{ log.created_at|localtime('%Y-%m-%d %H:%M:%S') if log.created_at else '-' }}</dd>
                    
                    <dt>Target</dt>
                    <dd>
                        <span class="badge bg-{{ 'primary' if log.target == 'community' else 'info' }}">
                            {{ log.target }}
                        </span>
                        {% if log.event %}
                        <br>{{ log.event.title }}
                        {% endif %}
                    </dd>
                    
                    <dt>Total Recipients</dt>
                    <dd>{{ log.total_recipients }}</dd>

                    <dt>Status</dt>
                    <dd>
                        <span class="badge bg-{% if log.status == 'processing' %}warning{% elif log.status == 'failed' %}danger{% else %}success{% endif %}">
                            {{ log.status or 'sent' }}
                        </span>
                    </dd>
                    
                    <dt>Results</dt>
                    <dd>
                        <span class="text-success"><i class="bi bi-check-circle me-1"></i>{{ log.success_count }} sent</span>
                        <br>
                        <span class="text-danger"><i class="bi bi-x-circle me-1"></i>{{ log.failure_count }} failed</span>
                    </dd>
                </dl>
            </div>
        </div>
    </div>

    <div class="col-lg-8 mb-4">
        <div class="card app-card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Message</h6>
            </div>
            <div class="card-body">
                <pre class="mb-0" style="white-space: pre-wrap;">{{ log.message_body }}</pre>
            </div>
        </div>

        <div class="card app-card">
            <div class="card-header">
                <h6 class="mb-0">Recipient Details</h6>
            </div>
            <div class="table-responsive">
                <table class="table table-sm mb-0" data-sortable="client">
                    <thead class="table-light">
                        <tr>
                            <th data-sort-type="string">
                                <button type="button" class="sort-button" data-sort-key="name">
                                    <span>Name</span>
                                    <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th data-sort-type="phone">
                                <button type="button" class="sort-button" data-sort-key="phone">
                                    <span>Phone</span>
                                    <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th data-sort-type="enum">
                                <button type="button" class="sort-button" data-sort-key="status">
                                    <span>Status</span>
                                    <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th data-sort-type="enum">
                                <button type="button" class="sort-button" data-sort-key="suppression">
                                    <span>Suppression</span>
                                    <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th data-sort-type="string">
                                <button type="button" class="sort-button" data-sort-key="error">
                                    <span>Error</span>
                                    <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if details %}
                        {% for d in details %}
                        <tr class="{{ 'table-danger' if not d.success else '' }}">
                            <td data-sort-value="{{ d.name or '' }}">{{ d.name or '-' }}</td>
                            <td data-sort-value="{{ d.phone }}"><code>{{ d.phone }}</code></td>
                            <td data-sort-value="{{ 'Sent' if d.success else 'Failed' }}">
                                {% if d.success %}
                                <span class="badge bg-success">Sent</span>
                                {% else %}
                                <span class="badge bg-danger">Failed</span>
                                {% endif %}
                            </td>
                            <td data-sort-value="{{ suppression_status.get(d.normalized_phone) or '' }}">
                                {% if not d.success and suppression_status.get(d.normalized_phone) %}
                                <span class="badge bg-warning text-dark text-uppercase">
                                    {{ suppression_status.get(d.normalized_phone) }}
                                </span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td data-sort-value="{{ d.error or '' }}">
                                {% if d.error %}
                                <small class="text-danger">{{ d.error }}</small>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-3">No details available.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const logStatusMeta = document.getElementById('logStatusMeta');
    if (logStatusMeta && logStatusMeta.dataset.status === 'processing') {
        const logId = logStatusMeta.dataset.logId;
        const initial = {
            status: logStatusMeta.dataset.status || 'sent',
            success: Number(logStatusMeta.dataset.successCount || 0),
            failure: Number(logStatusMeta.dataset.failureCount || 0),
        };

        async function checkLogStatus() {
            try {
                const response = await fetch(`/logs/status?ids=${encodeURIComponent(logId)}`);
                if (!response.ok) return;
                const payload = await response.json();
                const current = Array.isArray(payload.logs)
                    ? payload.logs.find((entry) => String(entry.id) === String(logId))
                    : null;
                if (!current) return;

                const status = current.status || 'sent';
                const success = Number(current.success_count || 0);
                const failure = Number(current.failure_count || 0);

                if (status !== initial.status || success !== initial.success || failure !== initial.failure) {
                    location.reload();
                }
            } catch (error) {
                console.error('Log status check failed:', error);
            }
        }

        setTimeout(() => setInterval(checkLogStatus, 3000), 1000);
    }
</script>
{% endblock %}
