{% extends "base.html" %}

{% block title %}Message Logs - SMS Admin{% endblock %}

{% block page_title %}Message Logs{% endblock %}

{% block breadcrumbs %}
<a href="{{ url_for('main.dashboard') }}">Dashboard</a> / <span>Logs</span>
{% endblock %}

{% block page_actions %}
{% if logs and current_user.is_admin %}
<button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#clearLogsModal">
    <i class="bi bi-trash me-1"></i>Clear All Logs
</button>
{% endif %}
{% endblock %}

{% block content %}
<div class="card app-card mb-4">
    <div class="card-body">
        <form class="filter-bar" method="GET" data-table-loading-target="logsTable">
            <div class="flex-grow-1">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" name="search" placeholder="Search logs" value="{{ search }}">
                </div>
            </div>
            <button type="submit" class="btn btn-secondary">
                <i class="bi bi-funnel me-1"></i>Apply
            </button>
        </form>
    </div>
</div>

<div class="card app-card">
    {% if logs %}
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="btn-group btn-group-sm" role="group" aria-label="Bulk selection">
            <button type="button" class="btn btn-outline-secondary" id="selectAllBtn">Select all</button>
            <button type="button" class="btn btn-outline-secondary" id="selectNoneBtn">Select none</button>
            <button type="button" class="btn btn-outline-secondary" id="invertSelectionBtn">Invert</button>
        </div>
        <div class="d-flex align-items-center">
            <span class="text-muted me-3"><span id="selectedCount">0</span> selected</span>
        </div>
    </div>
    {% endif %}
    <div class="table-responsive d-none d-lg-block">
        <table class="table table-hover table-sticky-header mb-0 table-loading" id="logsTable">
            <thead class="table-light">
                <tr>
                    <th width="40">
                        {% if logs %}
                        <input class="form-check-input" type="checkbox" id="selectAllLogs" aria-label="Select all logs">
                        {% endif %}
                    </th>
                    <th>Date</th>
                    <th>Target</th>
                    <th>Message</th>
                    <th>Results</th>
                    <th width="80"></th>
                </tr>
            </thead>
            <tbody class="table-data">
                {% if logs %}
                {% for log in logs %}
                <tr>
                    <td>
                        <input class="form-check-input js-select-row" type="checkbox" aria-label="Select log">
                    </td>
                    <td>{{ log.created_at|localtime }}</td>
                    <td>
                        <span class="badge bg-{{ 'primary' if log.target == 'community' else 'info' }}">
                            {{ log.target }}
                        </span>
                        {% if log.event %}
                        <br><small class="text-muted">{{ log.event.title }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span title="{{ log.message_body }}">
                            {{ log.message_body[:50] }}{% if log.message_body|length > 50 %}...{% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="mb-1">
                            <span class="badge bg-{% if log.status == 'processing' %}warning{% elif log.status == 'failed' %}danger{% else %}success{% endif %}">
                                {{ log.status or 'sent' }}
                            </span>
                        </div>
                        <span class="text-success">{{ log.success_count }} sent</span>
                        {% if log.failure_count > 0 %}
                        / <span class="text-danger">{{ log.failure_count }} failed</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex flex-wrap gap-1 row-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    data-bs-toggle="offcanvas" data-bs-target="#logPreview{{ log.id }}"
                                    aria-controls="logPreview{{ log.id }}">
                                <i class="bi bi-layout-sidebar-inset"></i>
                            </button>
                            <a href="{{ url_for('main.log_detail', log_id=log.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="6" class="py-5">
                        <div class="empty-state">
                            <i class="bi bi-journal-x empty-state__icon"></i>
                            <div class="empty-state__title">No message logs yet</div>
                            <div class="empty-state__text">Send your first message to see delivery history.</div>
                            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary btn-sm">
                                <i class="bi bi-send me-1"></i>Send Message
                            </a>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
            <tbody class="table-skeleton-body" aria-hidden="true">
                {% for _ in range(5) %}
                <tr>
                    <td><span class="skeleton-block" style="width: 1rem;"></span></td>
                    <td><span class="skeleton-block w-50"></span></td>
                    <td><span class="skeleton-block w-25"></span></td>
                    <td><span class="skeleton-block w-75"></span></td>
                    <td><span class="skeleton-block w-50"></span></td>
                    <td><span class="skeleton-block w-25"></span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="card-list d-lg-none">
        {% if logs %}
            {% for log in logs %}
            <div class="card-list-item">
                <div class="d-flex justify-content-between align-items-start gap-2">
                    <div>
                        <h6 class="mb-1">{{ log.created_at|localtime }}</h6>
                        <div class="text-muted small">
                            {{ log.target }}{% if log.event %} Â· {{ log.event.title }}{% endif %}
                        </div>
                        <div class="mt-1">
                            <span class="badge bg-{% if log.status == 'processing' %}warning{% elif log.status == 'failed' %}danger{% else %}success{% endif %}">
                                {{ log.status or 'sent' }}
                            </span>
                        </div>
                        <div class="text-muted small">{{ log.message_body[:50] }}{% if log.message_body|length > 50 %}...{% endif %}</div>
                    </div>
                    <input class="form-check-input js-select-row" type="checkbox" aria-label="Select log">
                </div>
                <div class="d-flex flex-wrap gap-2 mt-3 row-actions">
                    <button type="button" class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="offcanvas" data-bs-target="#logPreview{{ log.id }}"
                            aria-controls="logPreview{{ log.id }}">
                        <i class="bi bi-layout-sidebar-inset"></i> Preview
                    </button>
                    <a href="{{ url_for('main.log_detail', log_id=log.id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> View
                    </a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state py-5">
                <i class="bi bi-journal-x empty-state__icon"></i>
                <div class="empty-state__title">No message logs yet</div>
                <div class="empty-state__text">Send your first message to see delivery history.</div>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-send me-1"></i>Send Message
                </a>
            </div>
        {% endif %}
    </div>
    {% if logs %}
    <div class="card-footer text-muted">
        Showing {{ logs|length }} log(s)
    </div>
    {% endif %}
</div>

{% if logs %}
    {% for log in logs %}
    <div class="offcanvas offcanvas-end preview-panel" tabindex="-1" id="logPreview{{ log.id }}">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Log preview</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <p class="mb-2"><strong>Target:</strong> {{ log.target }}</p>
            <p class="mb-2"><strong>Status:</strong> {{ log.status or 'sent' }}</p>
            <p class="mb-2"><strong>Sent:</strong> {{ log.success_count }} success / {{ log.failure_count }} failed</p>
            <p class="mb-0"><strong>Message:</strong> {{ log.message_body }}</p>
        </div>
    </div>
    {% endfor %}
{% endif %}

{% if current_user.is_admin %}
<!-- Clear Logs Modal -->
<div class="modal fade" id="clearLogsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger me-2"></i>Clear All Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.logs_clear') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This will permanently delete all message logs. This action cannot be undone.
                    </div>
                    <div class="mb-3">
                        <label for="admin_password" class="form-label">Enter Admin Password to confirm:</label>
                        <input type="password" class="form-control" id="admin_password" name="admin_password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Clear All Logs
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const bulkActionBar = document.getElementById('bulkActionBar');
    const selectedCountEl = document.getElementById('selectedCount');
    const selectAllLogs = document.getElementById('selectAllLogs');

    function isDesktopView() {
        return window.matchMedia('(min-width: 992px)').matches;
    }

    function getLogCheckboxes() {
        const container = isDesktopView()
            ? document.querySelector('.table-responsive.d-lg-block')
            : document.querySelector('.card-list.d-lg-none');
        if (!container) {
            return [];
        }
        return Array.from(container.querySelectorAll('.js-select-row'));
    }

    function updateBulkUi() {
        if (!selectedCountEl || !bulkActionBar) return;
        const boxes = getLogCheckboxes();
        const selected = boxes.filter(b => b.checked).length;
        selectedCountEl.textContent = selected;
        bulkActionBar.classList.toggle('is-visible', selected > 0);
        if (selectAllLogs) {
            if (isDesktopView()) {
                selectAllLogs.checked = boxes.length > 0 && boxes.every(b => b.checked);
                selectAllLogs.indeterminate = selected > 0 && selected < boxes.length;
            } else {
                selectAllLogs.checked = false;
                selectAllLogs.indeterminate = false;
            }
        }
    }

    if (selectAllLogs) {
        selectAllLogs.addEventListener('change', function() {
            const boxes = getLogCheckboxes();
            boxes.forEach(b => { b.checked = selectAllLogs.checked; });
            updateBulkUi();
        });
    }

    const selectAllBtn = document.getElementById('selectAllBtn');
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            const boxes = getLogCheckboxes();
            boxes.forEach(b => { b.checked = true; });
            updateBulkUi();
        });
    }

    const selectNoneBtn = document.getElementById('selectNoneBtn');
    if (selectNoneBtn) {
        selectNoneBtn.addEventListener('click', function() {
            const boxes = getLogCheckboxes();
            boxes.forEach(b => { b.checked = false; });
            updateBulkUi();
        });
    }

    const invertSelectionBtn = document.getElementById('invertSelectionBtn');
    if (invertSelectionBtn) {
        invertSelectionBtn.addEventListener('click', function() {
            const boxes = getLogCheckboxes();
            boxes.forEach(b => { b.checked = !b.checked; });
            updateBulkUi();
        });
    }

    window.addEventListener('resize', updateBulkUi);

    Array.from(document.querySelectorAll('.js-select-row'))
        .forEach(b => b.addEventListener('change', updateBulkUi));
    updateBulkUi();
</script>
{% endblock %}
