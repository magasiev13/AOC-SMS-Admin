{% extends "base.html" %}

{% block title %}Message Logs - SMS Admin{% endblock %}

{% block page_title %}Message Logs{% endblock %}

{% block breadcrumbs %}
<a href="{{ url_for('main.dashboard') }}">Dashboard</a> / <span>Logs</span>
{% endblock %}

{% block page_actions %}
{% if logs and current_user.is_admin %}
<button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#clearLogsModal">
    <i class="bi bi-trash me-1"></i>Clear All Logs
</button>
{% endif %}
{% endblock %}

{% block content %}
<div id="logListStatusMeta" class="d-none"
     data-processing-logs='{{ processing_logs|tojson }}'></div>
<div class="card app-card mb-4">
    <div class="card-body">
        <form class="filter-bar" method="GET" data-table-loading-target="logsTable">
            <div class="flex-grow-1">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" name="search" placeholder="Search logs" aria-label="Search logs" value="{{ search }}">
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card app-card">
    <div class="table-responsive d-none d-lg-block">
        <table class="table table-hover table-sticky-header mb-0 table-loading" id="logsTable" data-sortable="client">
            <thead class="table-light">
                <tr>
                    <th data-sort-type="date">
                        <button type="button" class="sort-button" data-sort-key="date">
                            <span>Date</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th data-sort-type="enum">
                        <button type="button" class="sort-button" data-sort-key="target">
                            <span>Target</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th data-sort-type="string">
                        <button type="button" class="sort-button" data-sort-key="message">
                            <span>Message</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th data-sort-type="number">
                        <button type="button" class="sort-button" data-sort-key="results">
                            <span>Results</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th width="80"></th>
                </tr>
            </thead>
            <tbody class="table-data">
                {% if logs %}
                {% for log in logs %}
                {% set target_label = 'Community' if log.target == 'community' else 'Event' %}
                {% set target_sort = target_label ~ (': ' ~ log.event.title if log.event else '') %}
                <tr>
                    <td data-sort-value="{{ log.created_at.isoformat() if log.created_at else '' }}">{{ log.created_at|localtime }}</td>
                    <td data-sort-value="{{ target_sort }}">
                        <span class="badge bg-{{ 'primary' if log.target == 'community' else 'info' }}">
                            {{ log.target }}
                        </span>
                        {% if log.event %}
                        <br><small class="text-muted">{{ log.event.title }}</small>
                        {% endif %}
                    </td>
                    <td data-sort-value="{{ log.message_body }}">
                        <span title="{{ log.message_body }}">
                            {{ log.message_body[:50] }}{% if log.message_body|length > 50 %}...{% endif %}
                        </span>
                    </td>
                    <td data-sort-value="{{ log.total_recipients or 0 }}">
                        <div class="mb-1">
                            <span class="badge bg-{% if log.status == 'processing' %}warning{% elif log.status == 'failed' %}danger{% else %}success{% endif %}">
                                {{ log.status or 'sent' }}
                            </span>
                        </div>
                        <span class="text-success">{{ log.success_count }} sent</span>
                        {% if log.failure_count > 0 %}
                        / <span class="text-danger">{{ log.failure_count }} failed</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex flex-wrap gap-1 row-actions">
                            <button type="button" class="btn btn-sm btn-outline-primary" aria-label="Preview message log" title="Preview"
                                    data-bs-toggle="offcanvas" data-bs-target="#logPreview{{ log.id }}"
                                    aria-controls="logPreview{{ log.id }}">
                                <i class="bi bi-layout-sidebar-inset"></i>
                            </button>
                            <a href="{{ url_for('main.log_detail', log_id=log.id) }}" class="btn btn-sm btn-outline-primary" aria-label="View log details" title="View details">
                                <i class="bi bi-eye"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" class="py-5">
                        <div class="empty-state">
                            <i class="bi bi-journal-x empty-state__icon"></i>
                            <div class="empty-state__title">No message logs yet</div>
                            <div class="empty-state__text">Send your first message to see delivery history.</div>
                            <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary btn-sm">
                                <i class="bi bi-send me-1"></i>Send Message
                            </a>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
            <tbody class="table-skeleton-body" aria-hidden="true">
                {% for _ in range(5) %}
                <tr>
                    <td><span class="skeleton-block w-50"></span></td>
                    <td><span class="skeleton-block w-25"></span></td>
                    <td><span class="skeleton-block w-75"></span></td>
                    <td><span class="skeleton-block w-50"></span></td>
                    <td><span class="skeleton-block w-25"></span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="card-list d-lg-none">
        {% if logs %}
            {% for log in logs %}
            <div class="card-list-item">
                <div class="d-flex justify-content-between align-items-start gap-2">
                    <div>
                        <h6 class="mb-1">{{ log.created_at|localtime }}</h6>
                        <div class="text-muted small">
                            {{ log.target }}{% if log.event %} Â· {{ log.event.title }}{% endif %}
                        </div>
                        <div class="mt-1">
                            <span class="badge bg-{% if log.status == 'processing' %}warning{% elif log.status == 'failed' %}danger{% else %}success{% endif %}">
                                {{ log.status or 'sent' }}
                            </span>
                        </div>
                        <div class="text-muted small">{{ log.message_body[:50] }}{% if log.message_body|length > 50 %}...{% endif %}</div>
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2 mt-3 row-actions">
                    <button type="button" class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="offcanvas" data-bs-target="#logPreview{{ log.id }}"
                            aria-controls="logPreview{{ log.id }}">
                        <i class="bi bi-layout-sidebar-inset"></i> Preview
                    </button>
                    <a href="{{ url_for('main.log_detail', log_id=log.id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> View
                    </a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state py-5">
                <i class="bi bi-journal-x empty-state__icon"></i>
                <div class="empty-state__title">No message logs yet</div>
                <div class="empty-state__text">Send your first message to see delivery history.</div>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary btn-sm">
                    <i class="bi bi-send me-1"></i>Send Message
                </a>
            </div>
        {% endif %}
    </div>
    {% if logs %}
    <div class="card-footer text-muted">
        Showing {{ logs|length }} log(s)
    </div>
    {% endif %}
</div>

{% if logs %}
    {% for log in logs %}
    <div class="offcanvas offcanvas-end preview-panel" tabindex="-1" id="logPreview{{ log.id }}">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Log preview</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <p class="mb-2"><strong>Target:</strong> {{ log.target }}</p>
            <p class="mb-2"><strong>Status:</strong> {{ log.status or 'sent' }}</p>
            <p class="mb-2"><strong>Sent:</strong> {{ log.success_count }} success / {{ log.failure_count }} failed</p>
            <p class="mb-0"><strong>Message:</strong> {{ log.message_body }}</p>
        </div>
    </div>
    {% endfor %}
{% endif %}

{% if current_user.is_admin %}
<!-- Clear Logs Modal -->
<div class="modal fade" id="clearLogsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger me-2"></i>Clear All Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('main.logs_clear') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Warning:</strong> This will permanently delete all message logs. This action cannot be undone.
                    </div>
                    <div class="mb-3">
                        <label for="admin_password" class="form-label">Enter Admin Password to confirm:</label>
                        <input type="password" class="form-control" id="admin_password" name="admin_password" required autocomplete="current-password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Clear All Logs
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    const logListStatusMeta = document.getElementById('logListStatusMeta');
    let processingLogs = [];
    if (logListStatusMeta && logListStatusMeta.dataset.processingLogs) {
        try {
            processingLogs = JSON.parse(logListStatusMeta.dataset.processingLogs);
        } catch (error) {
            processingLogs = [];
        }
    }

    const processingIds = processingLogs.map((log) => log.id).filter(Boolean);
    const baseline = new Map(
        processingLogs.map((log) => [
            String(log.id),
            {
                status: log.status || 'sent',
                success: Number(log.success_count || 0),
                failure: Number(log.failure_count || 0),
            },
        ])
    );

    async function checkLogListStatus() {
        if (!processingIds.length) return;
        try {
            const response = await fetch(`/logs/status?ids=${processingIds.join(',')}`);
            if (!response.ok) return;
            const payload = await response.json();
            const logs = Array.isArray(payload.logs) ? payload.logs : [];
            const currentMap = new Map(
                logs.map((log) => [
                    String(log.id),
                    {
                        status: log.status || 'sent',
                        success: Number(log.success_count || 0),
                        failure: Number(log.failure_count || 0),
                    },
                ])
            );

            for (const [id, initial] of baseline.entries()) {
                const current = currentMap.get(id);
                if (!current) {
                    location.reload();
                    return;
                }
                if (
                    current.status !== initial.status ||
                    current.success !== initial.success ||
                    current.failure !== initial.failure
                ) {
                    location.reload();
                    return;
                }
            }
        } catch (error) {
            console.error('Log list status check failed:', error);
        }
    }

    if (processingIds.length > 0) {
        setTimeout(() => setInterval(checkLogListStatus, 3000), 1000);
    }
</script>
{% endblock %}
