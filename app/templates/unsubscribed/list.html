{% extends "base.html" %}

{% block title %}Suppression - SMS Admin{% endblock %}

{% block page_title %}Suppression{% endblock %}

{% set can_manage_unsubscribed = current_user.is_admin %}

{% block breadcrumbs %}
<a href="{{ url_for('main.dashboard') }}">Dashboard</a> / <span>Suppression</span>
{% endblock %}

{% block page_actions %}
{% if can_manage_unsubscribed %}
<form method="POST" action="{{ url_for('main.unsubscribed_backfill') }}" class="d-inline page-action-secondary" data-backfill-form>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-outline-warning" data-backfill-button>
        <i class="bi bi-arrow-repeat me-1"></i>Backfill from Logs
    </button>
</form>
<a href="{{ url_for('main.unsubscribed_import') }}" class="btn btn-outline-primary page-action-secondary">
    <i class="bi bi-upload me-1"></i>Import CSV
</a>
<a href="{{ url_for('main.unsubscribed_export') }}" class="btn btn-outline-secondary page-action-secondary">
    <i class="bi bi-download me-1"></i>Export CSV
</a>
<a href="{{ url_for('main.unsubscribed_add') }}" class="btn btn-primary page-action-primary">
    <i class="bi bi-plus-lg me-1"></i>Add to Suppression
</a>
{% endif %}
{% endblock %}

{% block content %}
<div class="alert alert-success d-none" role="status" aria-live="polite" id="backfillAlert"></div>
<div class="card app-card mb-4">
    <div class="card-body">
        <form method="GET" class="filter-bar" data-table-loading-target="unsubscribedTable">
            <div class="flex-grow-1">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" name="search" placeholder="Search by name, phone, reason, category, or source..." aria-label="Search suppression list"
                           value="{{ search }}">
                </div>
            </div>
            <input type="hidden" name="sort" value="{{ sort_key }}">
            <input type="hidden" name="dir" value="{{ sort_dir }}">
        </form>
    </div>
</div>

<div class="card app-card">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="btn-group btn-group-sm" role="group" aria-label="Bulk selection">
            <button type="button" class="btn btn-outline-secondary" id="selectAllBtn">Select all</button>
            <button type="button" class="btn btn-outline-secondary" id="selectNoneBtn">Select none</button>
        </div>
        <div class="bulk-selection-actions" id="bulkSelectionActions">
            <span class="text-muted"><span id="selectedCount">0</span> selected</span>
            <button type="button" class="btn btn-sm btn-danger" id="bulkDeleteBtn"
                    data-bs-toggle="modal" data-bs-target="#bulkDeleteModal">
                <i class="bi bi-trash me-1"></i>Delete selected
            </button>
        </div>
        <form id="bulkDeleteForm" method="POST" action="{{ url_for('main.unsubscribed_bulk_delete') }}" style="display:none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        </form>
    </div>
    <div class="table-responsive d-none d-lg-block">
        <table class="table table-hover table-sticky-header mb-0 table-loading" id="unsubscribedTable" data-sortable="server" data-sort-default="created_at" data-sort-default-dir="desc">
            <thead class="table-light">
                <tr>
                    <th width="40">
                        {% if entries %}
                        <input class="form-check-input" type="checkbox" id="selectAllEntries" aria-label="Select all entries">
                        {% endif %}
                    </th>
                    <th data-sort-type="string">
                        <button type="button" class="sort-button" data-sort-key="name">
                            <span>Name</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th data-sort-type="phone">
                        <button type="button" class="sort-button" data-sort-key="phone">
                            <span>Phone</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th data-sort-type="string">
                        <button type="button" class="sort-button" data-sort-key="reason">
                            <span>Reason</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th data-sort-type="enum">
                        <button type="button" class="sort-button" data-sort-key="category">
                            <span>Category</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th data-sort-type="enum">
                        <button type="button" class="sort-button" data-sort-key="source">
                            <span>Source</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    <th data-sort-type="date">
                        <button type="button" class="sort-button" data-sort-key="created_at">
                            <span>Added</span>
                            <span class="sort-indicator" aria-hidden="true"></span>
                        </button>
                    </th>
                    {% if can_manage_unsubscribed %}
                    <th width="80">Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody class="table-data">
                {% if entries %}
                    {% for entry in entries %}
                    <tr>
                        <td>
                            {% if entry.entry_type == 'unsubscribed' %}
                            <input class="form-check-input entry-checkbox" type="checkbox" name="unsubscribed_ids" value="{{ entry.id }}" form="bulkDeleteForm" aria-label="Select entry">
                            {% else %}
                            <input class="form-check-input entry-checkbox" type="checkbox" name="suppressed_ids" value="{{ entry.id }}" form="bulkDeleteForm" aria-label="Select entry">
                            {% endif %}
                        </td>
                        <td data-sort-value="{{ entry.name or '' }}">{{ entry.name or '-' }}</td>
                        <td data-sort-value="{{ entry.phone }}"><code>{{ entry.phone }}</code></td>
                        <td data-sort-value="{{ entry.reason or '' }}">{{ entry.reason or '-' }}</td>
                        <td data-sort-value="{{ entry.category }}">
                            <span class="badge bg-light text-dark text-uppercase">{{ entry.category }}</span>
                        </td>
                        <td data-sort-value="{{ entry.source or '' }}"><span class="badge bg-light text-dark">{{ entry.source or '-' }}</span></td>
                        <td data-sort-value="{{ entry.created_at.isoformat() if entry.created_at else '' }}">{{ entry.created_at.strftime('%Y-%m-%d') if entry.created_at else '-' }}</td>
                        {% if can_manage_unsubscribed %}
                        <td>
                            {% if entry.entry_type == 'unsubscribed' %}
                            <form method="POST" action="{{ url_for('main.unsubscribed_delete', entry_id=entry.id) }}" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove" aria-label="Remove entry">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                            {% else %}
                            <span class="text-muted small">Managed via suppression</span>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="{{ 8 if can_manage_unsubscribed else 7 }}" class="text-center text-muted py-4">
                            No suppression entries found.
                            {% if can_manage_unsubscribed %}
                            <a href="{{ url_for('main.unsubscribed_add') }}">Add one</a> or
                            <a href="{{ url_for('main.unsubscribed_import') }}">import from CSV</a>.
                            {% endif %}
                        </td>
                    </tr>
                {% endif %}
            </tbody>
            <tbody class="table-skeleton-body" aria-hidden="true">
                {% for _ in range(5) %}
                <tr>
                    <td><span class="skeleton-block w-25"></span></td>
                    <td><span class="skeleton-block w-75"></span></td>
                    <td><span class="skeleton-block w-50"></span></td>
                    <td><span class="skeleton-block w-75"></span></td>
                    <td><span class="skeleton-block w-50"></span></td>
                    <td><span class="skeleton-block w-50"></span></td>
                    <td><span class="skeleton-block w-50"></span></td>
                    {% if can_manage_unsubscribed %}
                    <td><span class="skeleton-block w-25"></span></td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="card-list d-lg-none">
        {% if entries %}
            {% for entry in entries %}
            <div class="card-list-item">
                <div class="d-flex justify-content-between align-items-start gap-2">
                    <div>
                        <h6 class="mb-1">{{ entry.name or '-' }}</h6>
                        <div class="text-muted small"><code>{{ entry.phone }}</code></div>
                        <div class="text-muted small mt-1">{{ entry.reason or '-' }}</div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <span class="badge bg-light text-dark text-uppercase">{{ entry.category }}</span>
                            <span class="badge bg-light text-dark">{{ entry.source or '-' }}</span>
                        </div>
                        <div class="text-muted small mt-2">Added {{ entry.created_at.strftime('%Y-%m-%d') if entry.created_at else '-' }}</div>
                    </div>
                    <div class="d-flex flex-column align-items-end gap-2">
                        {% if entry.entry_type == 'unsubscribed' %}
                        <input class="form-check-input entry-checkbox" type="checkbox" name="unsubscribed_ids" value="{{ entry.id }}" form="bulkDeleteForm" aria-label="Select entry">
                        {% else %}
                        <input class="form-check-input entry-checkbox" type="checkbox" name="suppressed_ids" value="{{ entry.id }}" form="bulkDeleteForm" aria-label="Select entry">
                        {% endif %}
                    </div>
                </div>
                {% if can_manage_unsubscribed and entry.entry_type == 'unsubscribed' %}
                <div class="d-flex flex-wrap gap-2 mt-3 row-actions">
                    <form method="POST" action="{{ url_for('main.unsubscribed_delete', entry_id=entry.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-sm btn-outline-danger" aria-label="Remove entry">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
        <div class="empty-state py-4">
            <i class="bi bi-person-x empty-state__icon"></i>
            <div class="empty-state__title">No suppression entries found</div>
            {% if can_manage_unsubscribed %}
            <div class="empty-state__text">Add a contact or import from CSV to get started.</div>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% if entries %}
    <div class="card-footer d-flex justify-content-between align-items-center text-muted">
        <span>Showing {{ entries|length }} of {{ total_count }} contact(s)</span>
        {% if total_pages > 1 %}
        <nav aria-label="Suppression list pagination">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.unsubscribed_list', search=search, page=page-1, sort=sort_key, dir=sort_dir) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                    <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                    {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('main.unsubscribed_list', search=search, page=p, sort=sort_key, dir=sort_dir) }}">{{ p }}</a></li>
                    {% elif p == page - 3 or p == page + 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.unsubscribed_list', search=search, page=page+1, sort=sort_key, dir=sort_dir) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Bulk Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Delete <strong id="bulkDeleteCount"></strong> selected entry/entries?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const backfillForm = document.querySelector('[data-backfill-form]');
    const backfillAlert = document.getElementById('backfillAlert');

    if (backfillForm) {
        const backfillButton = backfillForm.querySelector('[data-backfill-button]');

        backfillForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (!confirm('Run suppression backfill from message logs?')) {
                return;
            }

            if (backfillButton) {
                backfillButton.disabled = true;
                backfillButton.classList.add('disabled');
                backfillButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Running backfill...';
            }

            if (backfillAlert) {
                backfillAlert.classList.add('d-none');
                backfillAlert.textContent = '';
            }

            try {
                const response = await fetch(backfillForm.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    credentials: 'same-origin',
                    body: new FormData(backfillForm),
                });

                const payload = await response.json().catch(() => ({}));
                if (!response.ok) {
                    throw new Error(payload?.error || 'Backfill failed.');
                }

                if (backfillAlert) {
                    backfillAlert.textContent = payload.message + ' Refreshing...';
                    backfillAlert.classList.remove('d-none');
                    backfillAlert.classList.remove('alert-danger');
                    backfillAlert.classList.add('alert-success');
                }
                setTimeout(function() { window.location.reload(); }, 1000);
            } catch (error) {
                const message = error instanceof Error ? error.message : 'Backfill failed.';
                if (backfillAlert) {
                    backfillAlert.textContent = message;
                    backfillAlert.classList.remove('d-none');
                    backfillAlert.classList.remove('alert-success');
                    backfillAlert.classList.add('alert-danger');
                } else {
                    alert(message);
                }
            } finally {
                if (backfillButton) {
                    backfillButton.disabled = false;
                    backfillButton.classList.remove('disabled');
                    backfillButton.innerHTML = '<i class="bi bi-arrow-repeat me-1" aria-hidden="true"></i>Backfill from Logs';
                }
            }
        });
    }

    // Bulk selection functionality
    const checkboxes = document.querySelectorAll('.entry-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllEntries');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const selectNoneBtn = document.getElementById('selectNoneBtn');
    const selectedCount = document.getElementById('selectedCount');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const bulkSelectionActions = document.getElementById('bulkSelectionActions');
    const bulkDeleteCount = document.getElementById('bulkDeleteCount');
    const confirmBulkDeleteBtn = document.getElementById('confirmBulkDeleteBtn');
    const bulkDeleteForm = document.getElementById('bulkDeleteForm');

    function updateBulkUi() {
        const checked = document.querySelectorAll('.entry-checkbox:checked');
        const count = checked.length;
        if (selectedCount) selectedCount.textContent = count;
        if (bulkSelectionActions) {
            bulkSelectionActions.classList.toggle('is-visible', count > 0);
        }
        if (bulkDeleteCount) bulkDeleteCount.textContent = count;
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = checkboxes.length > 0 && count === checkboxes.length;
            selectAllCheckbox.indeterminate = count > 0 && count < checkboxes.length;
        }
    }

    checkboxes.forEach(function(cb) {
        cb.addEventListener('change', updateBulkUi);
    });

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            checkboxes.forEach(function(cb) { cb.checked = selectAllCheckbox.checked; });
            updateBulkUi();
        });
    }

    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            checkboxes.forEach(function(cb) { cb.checked = true; });
            updateBulkUi();
        });
    }

    if (selectNoneBtn) {
        selectNoneBtn.addEventListener('click', function() {
            checkboxes.forEach(function(cb) { cb.checked = false; });
            updateBulkUi();
        });
    }

    if (confirmBulkDeleteBtn && bulkDeleteForm) {
        confirmBulkDeleteBtn.addEventListener('click', function() {
            bulkDeleteForm.submit();
        });
    }

    updateBulkUi();
</script>
{% endblock %}
