{% extends "base.html" %}

{% block title %}Dashboard - SMS Admin{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block breadcrumbs %}
<span class="live-indicator"><span class="live-indicator__dot"></span> Live</span>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-xl-12">
        <!-- Stats Row -->
        <section class="mb-4">
            <div class="row g-3">
                <!-- Total Recipients -->
                <div class="col-sm-6 col-xl-3">
                    <div class="stat-card stat-card--primary h-100">
                        <i class="bi bi-people-fill stat-card__icon"></i>
                        <div class="stat-card__label">Total Recipients</div>
                        <div class="stat-card__value">{{ total_recipients }}</div>
                        <div class="stat-card__meta">
                            {{ community_count }} community • {{ event_registration_count }} RSVPs
                        </div>
                    </div>
                </div>

                <!-- Last Blast Status -->
                <div class="col-sm-6 col-xl-3">
                    <div class="stat-card stat-card--{% if latest_log and latest_log.failure_count == 0 %}success{% elif latest_log %}warning{% else %}dark{% endif %} h-100">
                        <i class="bi bi-send-check-fill stat-card__icon"></i>
                        <div class="stat-card__label">Last Blast</div>
                        {% if latest_log %}
                        <div class="stat-card__value">
                            {% if latest_log.failure_count == 0 %}Delivered{% else %}Partial{% endif %}
                        </div>
                        <div class="stat-card__meta">
                            {{ latest_log.success_count }}/{{ latest_log.total_recipients }} sent
                        </div>
                        {% else %}
                        <div class="stat-card__value">—</div>
                        <div class="stat-card__meta">No blasts sent yet</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Delivery Rate -->
                <div class="col-sm-6 col-xl-3">
                    <div class="stat-card stat-card--info h-100">
                        <i class="bi bi-check-circle-fill stat-card__icon"></i>
                        <div class="stat-card__label">Delivery Rate</div>
                        {% if success_rate is not none %}
                        <div class="stat-card__value stat-card__value--rate">
                            <span class="stat-card__percentage">{{ success_rate|int }}</span><span class="stat-card__percent-sign">%</span>
                        </div>
                        <div class="stat-card__progress">
                            <div class="stat-card__progress-bar" style="width: {{ success_rate }}%"></div>
                        </div>
                        <div class="stat-card__meta">{{ failure_rate }}% failed</div>
                        {% else %}
                        <div class="stat-card__value">N/A</div>
                        <div class="stat-card__meta">No data yet</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Scheduled Queue -->
                <div class="col-sm-6 col-xl-3">
                    <div class="stat-card stat-card--purple h-100">
                        <i class="bi bi-clock-fill stat-card__icon"></i>
                        <div class="stat-card__label">Scheduled</div>
                        <div class="stat-card__value">{{ pending_scheduled_count }}</div>
                        <div class="stat-card__meta">
                            <a href="{{ url_for('main.scheduled_list') }}">View queue →</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Charts Row -->
        <section class="mb-4">
            <div class="row g-3">
                <!-- Delivery Trends Chart -->
                <div class="col-lg-8">
                    <div class="chart-card h-100">
                        <div class="chart-card__header">
                            <h6 class="chart-card__title">
                                <i class="bi bi-graph-up"></i> Delivery Trends
                            </h6>
                            <span class="text-muted small">Last 7 days</span>
                        </div>
                        <div class="chart-container">
                            <canvas id="deliveryTrendsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Audience Breakdown -->
                <div class="col-lg-4">
                    <div class="chart-card h-100">
                        <div class="chart-card__header">
                            <h6 class="chart-card__title">
                                <i class="bi bi-pie-chart"></i> Audience
                            </h6>
                        </div>
                        <div class="chart-container chart-container--sm">
                            <canvas id="audienceChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="chart-legend__item">
                                <span class="chart-legend__color" style="background: #6366f1"></span>
                                Community ({{ community_count }})
                            </div>
                            <div class="chart-legend__item">
                                <span class="chart-legend__color" style="background: #8b5cf6"></span>
                                Event RSVPs ({{ event_registration_count }})
                            </div>
                            <div class="chart-legend__item">
                                <span class="chart-legend__color" style="background: #e2e8f0"></span>
                                Suppression ({{ unsubscribed_count }})
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick Links -->
        <section class="mb-4">
            <div class="quick-links">
                <a href="{{ url_for('main.inbox_list') }}" class="quick-link">
                    <i class="bi bi-chat-left-text quick-link__icon"></i>
                    <span class="quick-link__label">Inbox</span>
                </a>
                <a href="{{ url_for('main.keyword_rules_list') }}" class="quick-link">
                    <i class="bi bi-magic quick-link__icon"></i>
                    <span class="quick-link__label">Automations</span>
                </a>
                <a href="{{ url_for('main.community_list') }}" class="quick-link">
                    <i class="bi bi-people quick-link__icon"></i>
                    <span class="quick-link__label">Community</span>
                </a>
                <a href="{{ url_for('main.events_list') }}" class="quick-link">
                    <i class="bi bi-calendar-event quick-link__icon"></i>
                    <span class="quick-link__label">Events ({{ events|length }})</span>
                </a>
                <a href="{{ url_for('main.scheduled_list') }}" class="quick-link">
                    <i class="bi bi-clock quick-link__icon"></i>
                    <span class="quick-link__label">Scheduled</span>
                </a>
                <a href="{{ url_for('main.logs_list') }}" class="quick-link">
                    <i class="bi bi-journal-text quick-link__icon"></i>
                    <span class="quick-link__label">Logs</span>
                </a>
                <a href="{{ url_for('main.unsubscribed_list') }}" class="quick-link">
                    <i class="bi bi-person-x quick-link__icon"></i>
                    <span class="quick-link__label">Suppression</span>
                </a>
            </div>
        </section>

        <section class="mb-4">
            <div class="row g-3">
                <div class="col-lg-4">
                    <div class="chart-card h-100">
                        <div class="chart-card__header">
                            <h6 class="chart-card__title"><i class="bi bi-chat-dots"></i> Inbound Engagement</h6>
                            <span class="text-muted small">Last 7 days</span>
                        </div>
                        <div class="mt-2">
                            <div class="mb-3">
                                <div class="h3 mb-0">{{ inbound_count_7d }}</div>
                                <div class="text-muted small">Inbound messages</div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted small">Unread threads</span>
                                <strong>{{ unread_threads_count }}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted small">Active surveys</span>
                                <strong>{{ active_survey_sessions }}</strong>
                            </div>
                            <a href="{{ url_for('main.inbox_list') }}" class="btn btn-sm btn-outline-primary mt-3">Open inbox</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="chart-card h-100">
                        <div class="chart-card__header">
                            <h6 class="chart-card__title"><i class="bi bi-hash"></i> Top Trigger Keywords</h6>
                            <span class="text-muted small">Inbound keyword matches</span>
                        </div>
                        {% if top_keywords %}
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>Keyword</th>
                                        <th>Matches</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in top_keywords %}
                                    <tr>
                                        <td><code>{{ item.keyword }}</code></td>
                                        <td>{{ item.hits }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state py-4">
                            <i class="bi bi-hash empty-state__icon"></i>
                            <div class="empty-state__text">No keyword activity yet.</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- Send SMS Section -->
        <section class="mb-4">
            <div class="send-card">
                <div class="send-card__header">
                    <h5><i class="bi bi-send-fill me-2"></i>Send SMS Blast</h5>
                </div>
                <div class="send-card__body">
                    <form method="POST" id="sendForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="client_timezone" id="client_timezone">
                        <div id="sendFormError" class="validation-message validation-message--error d-none" role="alert" aria-live="assertive"></div>
                        <div id="sendFormStatus" class="visually-hidden" role="status" aria-live="polite" aria-atomic="true"></div>
                        <div class="mb-3">
                            <label for="message_body" class="form-label">Message</label>
                            <textarea class="form-control" id="message_body" name="message_body" rows="4"
                                      placeholder="Enter your message..." required maxlength="1600"></textarea>
                            <div class="form-text">
                                <span><span id="charCount">0</span> / 1600 characters</span>
                                <span class="ms-2">Estimated segments: <span id="segmentCount">0</span> (160 chars per segment, longer messages will split)</span>
                                <span class="ms-2">Personalize with <code>{first_name}</code> or <code>{full_name}</code>.</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Target Audience</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="target" id="targetCommunity"
                                       value="community" checked>
                                <label class="form-check-label" for="targetCommunity">
                                    <i class="bi bi-people me-1"></i>Community Blast
                                    <span class="text-muted">(all community recipients)</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="target" id="targetEvent"
                                       value="event">
                                <label class="form-check-label" for="targetEvent">
                                    <i class="bi bi-calendar-event me-1"></i>Event Blast
                                    <span class="text-muted">(registered event attendees)</span>
                                </label>
                            </div>
                            <div class="form-text">
                                Choose Community to reach your master list, or Event to target a single registration list.
                            </div>
                        </div>

                        <div class="mb-3" id="eventSelectWrapper" style="display: none;">
                            <label for="event_id" class="form-label">Select Event</label>
                            <select class="form-select" id="event_id" name="event_id">
                                <option value="">-- Select an event --</option>
                                {% for event in events %}
                                <option value="{{ event.id }}">
                                    {{ event.title }}{% if event.date %} ({{ event.date.strftime('%Y-%m-%d') }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_unsubscribe" id="includeUnsubscribe" checked>
                                <label class="form-check-label" for="includeUnsubscribe">
                                    <i class="bi bi-shield-check me-1"></i><strong>Include unsubscribe option</strong>
                                    <span class="text-muted">- Appends "Reply STOP to unsubscribe"</span>
                                </label>
                            </div>
                        </div>

                        <details class="advanced-options mb-3">
                            <summary class="advanced-options__summary">
                                <i class="bi bi-sliders me-2"></i>Advanced options
                            </summary>
                            <div class="mt-3">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="schedule_later" id="scheduleLater">
                                        <label class="form-check-label" for="scheduleLater">
                                            <i class="bi bi-clock me-1"></i><strong>Schedule for later</strong>
                                        </label>
                                    </div>
                                    <div class="form-text">
                                        Schedule sends in your local time ({{ app_timezone }} fallback). Detected timezone:
                                        <span id="timezoneHint">Unavailable</span>.
                                    </div>
                                </div>

                                <div class="mb-3" id="scheduleWrapper" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="schedule_date" class="form-label">Date</label>
                                            <input type="date" class="form-control" id="schedule_date" name="schedule_date">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="schedule_time" class="form-label">Time</label>
                                            <input type="time" class="form-control" id="schedule_time" name="schedule_time">
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>Enter your local time. The scheduler checks every 5 seconds in development, 30 seconds in production.
                                    </div>
                                </div>

                                {% if admin_test_phone %}
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="test_mode" id="testMode">
                                        <label class="form-check-label" for="testMode">
                                            <i class="bi bi-bug me-1"></i><strong>Test Mode</strong> - Send only to my phone ({{ admin_test_phone }})
                                        </label>
                                    </div>
                                    <div class="form-text text-warning">
                                        <i class="bi bi-exclamation-triangle me-1"></i>Uncheck to send to all recipients
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </details>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="sendBtn">
                                <i class="bi bi-send-fill me-2"></i>Send Now
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Recent Activity Timeline -->
        <section class="mb-4">
            <div class="section-header">
                <h5 class="section-title"><i class="bi bi-activity"></i> Recent Activity</h5>
                <a href="{{ url_for('main.logs_list') }}" class="btn btn-sm btn-outline-primary">View all logs</a>
            </div>
            
            {% if recent_logs %}
            <div class="activity-timeline">
                {% for log in recent_logs %}
                <div class="activity-item activity-item--{% if log.failure_count == 0 %}success{% elif log.failure_count < log.success_count %}warning{% else %}danger{% endif %}">
                    <div class="activity-item__content">
                        <div class="activity-item__header">
                            <div class="activity-item__title">{{ log.message_body|truncate(60) }}</div>
                            <span class="activity-item__time">{{ log.created_at|localtime('%b %d, %H:%M') }}</span>
                        </div>
                        <div class="activity-item__meta">
                            <span class="activity-item__badge activity-item__badge--success">
                                <i class="bi bi-check-circle"></i> {{ log.success_count }} sent
                            </span>
                            {% if log.failure_count %}
                            <span class="activity-item__badge activity-item__badge--danger">
                                <i class="bi bi-x-circle"></i> {{ log.failure_count }} failed
                            </span>
                            {% endif %}
                            <span class="activity-item__badge activity-item__badge--info">
                                {{ log.target|capitalize }}{% if log.event %}: {{ log.event.title }}{% endif %}
                            </span>
                            <a href="{{ url_for('main.log_detail', log_id=log.id) }}" class="btn btn-sm btn-outline-primary ms-auto">
                                Details <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="chart-card">
                <div class="empty-state">
                    <i class="bi bi-inbox empty-state__icon"></i>
                    <div class="empty-state__title">No activity yet</div>
                    <div class="empty-state__text">Send your first SMS blast to see activity here.</div>
                </div>
            </div>
            {% endif %}
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const messageBody = document.getElementById('message_body');
    const charCount = document.getElementById('charCount');
    const segmentCount = document.getElementById('segmentCount');
    const targetEvent = document.getElementById('targetEvent');
    const targetCommunity = document.getElementById('targetCommunity');
    const eventSelectWrapper = document.getElementById('eventSelectWrapper');
    const sendForm = document.getElementById('sendForm');
    const sendBtn = document.getElementById('sendBtn');
    const sendFormError = document.getElementById('sendFormError');
    const sendFormStatus = document.getElementById('sendFormStatus');
    const scheduleLater = document.getElementById('scheduleLater');
    const scheduleWrapper = document.getElementById('scheduleWrapper');
    const scheduleDate = document.getElementById('schedule_date');
    const scheduleTime = document.getElementById('schedule_time');
    const clientTimezone = document.getElementById('client_timezone');
    const timezoneHint = document.getElementById('timezoneHint');

    function getCookieValue(name) {
        const match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
        return match ? decodeURIComponent(match[1]) : '';
    }

    if (clientTimezone) {
        try {
            const resolvedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
            clientTimezone.value = resolvedTimezone;
            if (timezoneHint) {
                timezoneHint.textContent = resolvedTimezone || 'Unavailable';
            }
            if (resolvedTimezone) {
                const existingTimezone = getCookieValue('client_timezone');
                if (existingTimezone !== resolvedTimezone) {
                    document.cookie = `client_timezone=${encodeURIComponent(resolvedTimezone)}; path=/; max-age=31536000; samesite=lax`;
                    window.location.reload();
                }
            }
        } catch (e) {
            clientTimezone.value = '';
            if (timezoneHint) {
                timezoneHint.textContent = 'Unavailable';
            }
        }
    }

    function estimateSegments(length) {
        if (length === 0) {
            return 0;
        }
        if (length <= 160) {
            return 1;
        }
        return Math.ceil(length / 153);
    }

    function updateMessageStats() {
        const length = messageBody.value.length;
        charCount.textContent = length;
        if (segmentCount) {
            segmentCount.textContent = estimateSegments(length);
        }
    }

    updateMessageStats();
    messageBody.addEventListener('input', updateMessageStats);

    function toggleEventSelect() {
        eventSelectWrapper.style.display = targetEvent.checked ? 'block' : 'none';
    }

    function toggleSchedule() {
        const isScheduled = scheduleLater.checked;
        scheduleWrapper.style.display = isScheduled ? 'block' : 'none';
        scheduleDate.required = isScheduled;
        scheduleTime.required = isScheduled;
        if (isScheduled) {
            sendBtn.innerHTML = '<i class="bi bi-clock me-2" aria-hidden="true"></i>Schedule Message';
        } else {
            sendBtn.innerHTML = '<i class="bi bi-send-fill me-2" aria-hidden="true"></i>Send Now';
        }
    }

    targetEvent.addEventListener('change', toggleEventSelect);
    targetCommunity.addEventListener('change', toggleEventSelect);
    scheduleLater.addEventListener('change', toggleSchedule);
    toggleEventSelect();
    toggleSchedule();

    function setValidationError(message) {
        if (!sendFormError) {
            return;
        }
        if (message) {
            sendFormError.textContent = message;
            sendFormError.classList.remove('d-none');
        } else {
            sendFormError.textContent = '';
            sendFormError.classList.add('d-none');
        }
    }

    function resetValidationState() {
        messageBody.classList.remove('is-invalid');
        scheduleDate.classList.remove('is-invalid');
        scheduleTime.classList.remove('is-invalid');
        document.getElementById('event_id').classList.remove('is-invalid');
        setValidationError('');
        if (sendFormStatus) {
            sendFormStatus.textContent = '';
        }
    }

    sendForm.addEventListener('submit', function(event) {
        resetValidationState();
        const errors = [];

        if (!messageBody.value.trim()) {
            errors.push('Message body is required.');
            messageBody.classList.add('is-invalid');
        }

        if (targetEvent.checked) {
            const eventSelect = document.getElementById('event_id');
            if (!eventSelect.value) {
                errors.push('Please select an event for the event blast.');
                eventSelect.classList.add('is-invalid');
            }
        }

        if (scheduleLater.checked) {
            if (!scheduleDate.value) {
                errors.push('Schedule date is required when scheduling.');
                scheduleDate.classList.add('is-invalid');
            }
            if (!scheduleTime.value) {
                errors.push('Schedule time is required when scheduling.');
                scheduleTime.classList.add('is-invalid');
            }
        }

        if (errors.length > 0) {
            event.preventDefault();
            setValidationError(errors[0]);
            if (sendFormStatus) {
                sendFormStatus.textContent = 'Please resolve the highlighted errors before sending.';
            }
            return;
        }

        sendBtn.disabled = true;
        if (scheduleLater.checked) {
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Scheduling...';
            if (sendFormStatus) {
                sendFormStatus.textContent = 'Scheduling your message. Please wait.';
            }
        } else {
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
            if (sendFormStatus) {
                sendFormStatus.textContent = 'Sending your message. Please wait.';
            }
        }
    });

    sendForm.addEventListener('input', resetValidationState);

    // ===== Chart.js Initialization =====
    
    // Chart data from server
    const chartData = {{ chart_data|tojson|safe if chart_data else '{}' }};
    
    // Delivery Trends Chart (Line/Area)
    const trendsCtx = document.getElementById('deliveryTrendsChart');
    if (trendsCtx && chartData.trends) {
        new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: chartData.trends.labels,
                datasets: [
                    {
                        label: 'Sent',
                        data: chartData.trends.sent,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Failed',
                        data: chartData.trends.failed,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ef4444',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: { size: 12, weight: '500' }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        titleFont: { size: 13, weight: '600' },
                        bodyFont: { size: 12 },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 11 }, color: '#64748b' }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { font: { size: 11 }, color: '#64748b', stepSize: 1 }
                    }
                }
            }
        });
    } else if (trendsCtx) {
        // No data - show empty state
        trendsCtx.parentElement.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-graph-up empty-state__icon" aria-hidden="true"></i>
                <div class="empty-state__title">No trend data yet</div>
                <div class="empty-state__text">Send messages to see delivery trends.</div>
            </div>
        `;
    }

    // Audience Donut Chart
    const audienceCtx = document.getElementById('audienceChart');
    if (audienceCtx) {
        const communityCount = {{ community_count }};
        const eventCount = {{ event_registration_count }};
        const unsubCount = {{ unsubscribed_count }};
        
        if (communityCount > 0 || eventCount > 0 || unsubCount > 0) {
            new Chart(audienceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Community', 'Event RSVPs', 'Suppression'],
                    datasets: [{
                        data: [communityCount, eventCount, unsubCount],
                        backgroundColor: ['#6366f1', '#8b5cf6', '#e2e8f0'],
                        borderWidth: 0,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: 6
                    },
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            padding: 12,
                            cornerRadius: 8
                        }
                    }
                }
            });
        } else {
            audienceCtx.parentElement.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-people empty-state__icon" aria-hidden="true"></i>
                    <div class="empty-state__text">No recipients yet</div>
                </div>
            `;
        }
    }
</script>
{% endblock %}
