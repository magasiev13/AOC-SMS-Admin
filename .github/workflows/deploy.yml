name: Deploy (main -> VPS)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Write SSH key + known_hosts
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          printf '%s\n' "${{ secrets.VPS_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_SSH_PORT }}
        run: |
          ssh -p "$VPS_PORT" \
            -i ~/.ssh/vps_key \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            "$VPS_USER@$VPS_HOST" 'bash -s' <<'REMOTE'
          set -euo pipefail

          echo "==> Bootstrap deploy script from repo"
          sudo -u smsadmin bash -c 'cd /opt/sms-admin && git pull --ff-only'
          sudo install -m 0755 /opt/sms-admin/deploy/deploy_sms_admin.sh /usr/local/bin/deploy_sms_admin.sh

          echo "==> Deploy: pull + deps + restart + hardening env sync"
          sudo /usr/local/bin/deploy_sms_admin.sh

          echo "==> Service status"
          sudo systemctl is-active --quiet sms
          sudo systemctl is-active --quiet sms-worker
          sudo systemctl is-active --quiet sms-scheduler.timer

          echo "==> Dependency assertions"
          PYTHON_VERSION="$(sudo -u smsadmin /opt/sms-admin/venv/bin/python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")"
          if [ "$PYTHON_VERSION" != "3.11" ]; then
            echo "❌ python version mismatch: expected 3.11, got $PYTHON_VERSION"
            exit 1
          fi

          CLICK_VERSION="$(sudo -u smsadmin /opt/sms-admin/venv/bin/python -c "from importlib.metadata import version; print(version('click'))")"
          if [ "$CLICK_VERSION" != "8.1.7" ]; then
            echo "❌ click version mismatch: expected 8.1.7, got $CLICK_VERSION"
            exit 1
          fi

          echo "==> RQ parser assertion (must emit no stderr warnings)"
          RQ_HELP_OUT="$(mktemp /tmp/rq_help_out.XXXXXX)"
          RQ_HELP_ERR="$(mktemp /tmp/rq_help_err.XXXXXX)"
          sudo -u smsadmin /opt/sms-admin/venv/bin/rq worker --help >"$RQ_HELP_OUT" 2>"$RQ_HELP_ERR"
          if [ -s "$RQ_HELP_ERR" ]; then
            echo "❌ rq worker --help produced stderr output:"
            cat "$RQ_HELP_ERR"
            rm -f "$RQ_HELP_OUT" "$RQ_HELP_ERR"
            exit 1
          fi
          rm -f "$RQ_HELP_OUT" "$RQ_HELP_ERR"

          echo "==> Timer assertions"
          grep -q "^OnUnitActiveSec=30$" /etc/systemd/system/sms-scheduler.timer || {
            echo "❌ sms-scheduler.timer OnUnitActiveSec is not 30"
            exit 1
          }
          TIMER_PROPS="$(systemctl show sms-scheduler.timer -p AccuracyUSec -p RandomizedDelayUSec)"
          echo "$TIMER_PROPS"
          echo "$TIMER_PROPS" | grep -q "^AccuracyUSec=1s$" || {
            echo "❌ sms-scheduler.timer AccuracyUSec is not 1s"
            exit 1
          }
          echo "$TIMER_PROPS" | grep -q "^RandomizedDelayUSec=0$" || {
            echo "❌ sms-scheduler.timer RandomizedDelayUSec is not 0"
            exit 1
          }

          # Strong signal that scheduled sending works: run oneshot once and confirm it succeeded
          sudo systemctl start sms-scheduler.service || true
          RESULT="$(sudo systemctl show -p Result --value sms-scheduler.service || true)"
          CODE="$(sudo systemctl show -p ExecMainStatus --value sms-scheduler.service || true)"
          if [ "$RESULT" != "success" ] || [ "$CODE" != "0" ]; then
            echo "❌ sms-scheduler.service did not succeed (Result=$RESULT ExecMainStatus=$CODE)"
            sudo systemctl status sms-scheduler.service --no-pager || true
            sudo journalctl -u sms-scheduler.service -n 160 --no-pager || true
            exit 1
          fi

          echo "==> Health check (Gunicorn direct)"
          curl -fsS http://127.0.0.1:8000/health >/dev/null

          echo "==> Security hardening env key assertions"
          for key in \
            AUTH_ATTEMPT_WINDOW_SECONDS \
            AUTH_LOCKOUT_SECONDS \
            AUTH_MAX_ATTEMPTS_IP_ACCOUNT \
            AUTH_MAX_ATTEMPTS_ACCOUNT \
            AUTH_MAX_ATTEMPTS_IP \
            SESSION_IDLE_TIMEOUT_MINUTES \
            REMEMBER_COOKIE_DURATION_DAYS \
            AUTH_PASSWORD_MIN_LENGTH \
            AUTH_PASSWORD_POLICY_ENFORCE \
            TRUSTED_HOSTS; do
            grep -q "^${key}=" /opt/sms-admin/.env || {
              echo "❌ missing ${key} in /opt/sms-admin/.env"
              exit 1
            }
          done

          echo "✅ Deploy complete and healthy"
          REMOTE
