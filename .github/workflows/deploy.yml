name: Deploy (main -> VPS)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Write SSH key + known_hosts
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_key
          chmod 600 ~/.ssh/vps_key
          printf '%s\n' "${{ secrets.VPS_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_SSH_PORT }}
        run: |
          ssh -p "$VPS_PORT" \
            -i ~/.ssh/vps_key \
            -o IdentitiesOnly=yes \
            -o StrictHostKeyChecking=yes \
            "$VPS_USER@$VPS_HOST" 'bash -s' <<'REMOTE'
          set -euo pipefail

          echo "==> Deploy: pull + deps + restart"
          sudo /usr/local/bin/deploy_sms_admin.sh

          echo "==> Service status"
          sudo systemctl is-active --quiet sms
          sudo systemctl is-active --quiet sms-worker
          sudo systemctl is-active --quiet sms-scheduler.timer

          # Strong signal that scheduled sending works: run oneshot once and confirm it succeeded
          sudo systemctl start sms-scheduler.service || true
          RESULT="$(sudo systemctl show -p Result --value sms-scheduler.service || true)"
          CODE="$(sudo systemctl show -p ExecMainStatus --value sms-scheduler.service || true)"
          if [ "$RESULT" != "success" ] || [ "$CODE" != "0" ]; then
            echo "❌ sms-scheduler.service did not succeed (Result=$RESULT ExecMainStatus=$CODE)"
            sudo systemctl status sms-scheduler.service --no-pager || true
            sudo journalctl -u sms-scheduler.service -n 160 --no-pager || true
            exit 1
          fi

          echo "==> Health check (Gunicorn direct)"
          curl -fsS http://127.0.0.1:8000/health >/dev/null

          echo "✅ Deploy complete and healthy"
          REMOTE
